<!DOCTYPE html>
<html>
<head>
<title>Billing</title>
<style>
body{font-family:Arial}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
</style>
</head>
<body>

<h2>SVLN SOLUTIONS – BILLING</h2>

Customer Mobile:
<input id="mobile" onblur="fetchCustomer()">
Customer Name:
<input id="cname"><br><br>

<select id="item"></select>
Qty <input id="qty" type="number" value="1" style="width:60px">
Rate <input id="price" style="width:80px">
<button onclick="addItem()">Add</button>

<table id="bill">
<tr><th>#</th><th>Item</th><th>Rate</th><th>Qty</th><th>Total</th></tr>
</table>

<h3>Grand Total: ₹ <span id="grand">0</span></h3>

Paid Amount:
<input id="paid" type="number" value="0">

<h3>Due Amount: ₹ <span id="due">0</span></h3>

<button onclick="saveBill()">Generate Bill</button>
<button onclick="window.print()">Print</button>

<script>
const API="https://script.google.com/macros/s/AKfycbzYV6MhuNK-yJRCg80ILwqOAVNz1WktoBjQPldYQDC6sR9HqaZNxcaI8i_WwZ24DPCB-g/exec";

let items=[], sno=1, grand=0;

fetch(API+"?action=products")
.then(r=>r.json())
.then(d=>{
  d.forEach(p=>{
    let o=document.createElement("option");
    o.value=p[0];
    o.text=p[1];
    o.dataset.price=p[3];
    item.appendChild(o);
  });
  price.value=item.options[0].dataset.price;
});
item.onchange=()=>price.value=item.options[item.selectedIndex].dataset.price;

function fetchCustomer(){
 fetch(API+"?action=getCustomer&mobile="+mobile.value)
 .then(r=>r.text())
 .then(n=>{if(n)cname.value=n});
}

function addItem(){
 let q=+qty.value, p=+price.value;
 let total=q*p;
 grand+=total;
 items.push({code:item.value,qty:q,price:p});

 let r=bill.insertRow();
 r.insertCell(0).innerText=sno++;
 r.insertCell(1).innerText=item.options[item.selectedIndex].text;
 r.insertCell(2).innerText=p;
 r.insertCell(3).innerText=q;
 r.insertCell(4).innerText=total;

 grandSpan();
}

function grandSpan(){
 grandEl.innerText=grand;
 due.innerText=(grand-(+paid.value||0));
}

paid.oninput=grandSpan;

function saveBill(){
 fetch(API+"?action=sell"+
 "&items="+encodeURIComponent(JSON.stringify(items))+
 "&cname="+cname.value+
 "&mobile="+mobile.value+
 "&paid="+paid.value)
 .then(r=>r.text())
 .then(b=>alert("Bill Generated: "+b));
}

const grandEl=document.getElementById("grand");
</script>

</body>
</html>
